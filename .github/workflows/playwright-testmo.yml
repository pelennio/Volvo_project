name: Playwright Tests

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Install Testmo CLI
        run: npm install -g @testmo/testmo-cli

      - name: Run Playwright tests and upload results to Testmo
        env:
          TESTMO_URL: ${{ secrets.TESTMO_URL }}
          TESTMO_TOKEN: ${{ secrets.TESTMO_TOKEN }}
        run: |
          testmo automation:run \
            --instance "$TESTMO_URL" \
            --token "$TESTMO_TOKEN" \
            --project "Volvo UI Tests" \
            --name "Playwright GitHub Run" \
            --results ./test-results/results.xml \
            -- npx playwright test --reporter=junit
